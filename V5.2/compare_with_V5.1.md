# QA

## 那麼 V5.2 跟 V5.1 的差異是什麼？

基於您上傳的檔案，V5.2 與 V5.1 的主要差異在於**核心目標從「追求獲利最大化」轉向「生存與風控」**，並引入了更嚴格的壓力測試機制。

以下是詳細的對比分析：

### 1. 核心哲學與目標差異

* **V5.1 (實驗與收斂)**：
    * **目標**：試圖透過複雜的 ML 模型 (L3 排序、L4 動態出場) 來優化策略。
    * **結果**：發現複雜模型在樣本外表現不佳，反而簡單的物理法則 (`Price > SMA200` + `RSI < 10` + `Hold 5 Days`) 最有效。最終確立了「極簡基石 (Minimalist Baseline)」。
    * **缺點**：雖然獲利強勁，但最大回撤 (MaxDD) 高達 -48%，在 2020/2022 年面臨破產風險。

* **V5.2 (風控與生存)**：
    * **目標**：**「生存優先」**。將重心從預測「哪隻股票會漲」轉向「該買多少 (Position Sizing)」以及「何時空手 (Market Filter)」。
    * **策略**：將 V5.1 的高回撤控制在 -20% ~ -25% 以內，同時保留大部分獲利。

### 2. 機制與架構變更

| 特徵 | V5.1 (Base/Aggressive) | V5.2 (Risk-Aware) |
| :--- | :--- | :--- |
| **倉位管理** | **固定權重** (Equal Weight) | **波動率目標倉位** (ATR Targeting)：波動大買少，波動小買多。 |
| **市場濾網** | L1 HMM (因滯後被暫時移除) / 靜態 SMA200 | **市場寬度熔斷 (Breadth Thrust)**：S&P 100 成分股 > SMA200 的比例低於 20% 時強制空手。 |
| **驗證方法** | 單一自選池回測 (Single Track) | **雙軌驗證 (Dual-Track)**：同時跑「自選池」與「全市場指數 (S&P 100)」以驗證普適性。 |
| **偏差處理** | 未特別處理倖存者偏差 | **毒性壓力測試 (Toxic Stress Test)**：主動加入已下市或暴跌的「毒藥股」來驗證風控能力。 |

### 3. 績效表現對比

根據 `comprehensive_report.csv` 的數據：

* **V5.1 (Aggressive)**：
    * 總回報：**690.68%** (最高)
    * 最大回撤：**-30.19%** (風險較高)
    * 夏普比率：0.83
    * *特點：獲利爆發力強，但在崩盤時受傷較重。*

* **V5.2 Custom (Merged Real)**：
    * 總回報：**481.60%** (次高)
    * 最大回撤：**-25.77%** (顯著降低)
    * 夏普比率：**0.87** (最高，代表風險調整後報酬最好)
    * *特點：透過 ATR 控倉與市場寬度濾網，成功在保留大部分獲利的同時降低了回撤。即使加入了毒性資產 (Merged)，績效反而優於僅有優質股的 Normal Pool，證明了風控系統能有效利用高波動。*

### 4. 程式碼實作差異

* **新增 `RiskManager` 模組**：V5.2 獨立出了 `risk_manager.py`，負責計算 ATR 部位大小與執行熔斷邏輯，取代了 V5.1 `backtesting_utils.py` 中較簡單的邏輯。
* **資料載入器升級**：V5.2 引入 `DataLoader` 與 `toxic_asset_pool.json`，支援「菁英池」、「毒藥池」與「混合池」的靈活切換，而 V5.1 僅讀取單一 `asset_pool.json`。

**總結來說，V5.2 是 V5.1 的「成熟化」版本。它犧牲了部分極端獲利，換取了在真實、殘酷市場中長期生存的能力。**


## 進出場方式 在 V5.2 跟 Ｖ5.1 有差別嗎？

根據您提供的檔案內容，**V5.2 與 V5.1 在「進出場方式」上有顯著的結構性差異**。V5.1 傾向於「固定規則」與「最大化獲利」，而 V5.2 則引入了「動態風控」與「生存優先」的邏輯。

以下是詳細的差異比較表：

### 1\. 進場機制 (Entry Strategy)

| 比較項目 | **V5.1 (Aggressive / Baseline)** | **V5.2 (Risk-Aware)** | 差異分析 |
| :--- | :--- | :--- | :--- |
| **觸發條件** | `RSI(2) < 10` 且 `Price > SMA(200)` | `RSI(2) < 10` 且 `Price > SMA(200)` | **無差異**：核心選股邏輯保持一致。 |
| **倉位管理 (Sizing)** | **等權重 (Equal Weight)**<br>資金均分給 N 檔股票 (例如每檔 20%)。 | **波動率目標 (ATR Sizing)**<br>根據個股波動率決定倉位。波動大買少，波動小買多。 | **V5.2 更安全**：避免在垃圾股高波動時重倉，這是 V5.2 能承受「毒藥股」的關鍵。 |
| **市場濾網 (Filter)** | **個股濾網**<br>僅檢查個股是否在 SMA200 之上。 | **市場寬度熔斷 (Breadth Thrust)**<br>若 S\&P 100 成分股 \> SMA200 的比例低於 20%，**全體停止進場**。 | **V5.2 有系統性防禦**：在 2020/2022 崩盤時，V5.2 會完全空手，而 V5.1 仍會嘗試接刀。 |
| **排序邏輯** | RSI 由低到高排序 (越低越優先) | RSI 由低到高排序 (越低越優先) | **無差異**：兩者都優先選擇「超賣最嚴重」的標的。 |

### 2\. 出場機制 (Exit Strategy)

| 比較項目 | **V5.1 (Aggressive / Baseline)** | **V5.2 (Risk-Aware)** | 差異分析 |
| :--- | :--- | :--- | :--- |
| **基本出場** | **固定持有 5 天 (Time-based)**<br>不論漲跌，時間到就賣。 | **混合出場 (Hybrid)**<br>持有 5 天 **或** 滿足技術條件即出場。 | **V5.2 更靈活**：不再死守 5 天，有機會提早獲利了結。 |
| **止盈機制 (TP)** | 無 (L4 動態止盈在研究中被廢除) | **技術止盈 (RSI \> 50)**<br>若持有期間 `RSI(2) > 50`，視為反彈完成，提早出場。 | **V5.2 鎖定利潤**：在反彈波段的高點提早離場，釋放資金並減少回吐風險。 |
| **緊急出場 (Stop)** | 無 (硬扛到第 5 天) | **系統性清倉 (Liquidation)**<br>若市場寬度訊號轉為「崩盤 (Crash)」，**強制清空所有持倉**。 | **V5.2 有保命符**：這是 V5.2 最大回撤能控制在 -25% 的主因，避免在崩盤主跌段持有部位。 |

### 總結

  * **V5.1 進出場是「剛性」的**：買入後就像射飛鏢，固定 20% 倉位，固定 5 天後看結果。這導致它在牛市賺很多，但在熊市會受重傷。
  * **V5.2 進出場是「彈性」的**：
      * **買多少**由風險 (ATR) 決定。
      * **能不能買**由大盤 (Breadth) 決定。
      * **何時賣**由技術指標 (RSI \> 50) 或 風險訊號 (Crash) 決定，不再死守 5 天。

這使得 V5.2 雖然在總回報上可能略低於 V5.1 (因為倉位較小且會過濾交易)，但其**生存能力 (Sharpe Ratio & MaxDD)** 顯著優於 V5.1。