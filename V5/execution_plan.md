### **ğŸ“ˆ å°ˆæ¡ˆ V5-ML åŸ·è¡Œè¨ˆç•«ï¼šè·¨æˆªé¢å‡å€¼å›æ­¸èˆ‡é»‘å¤©éµé˜²ç¦¦ç³»çµ± (ä¿®è¨‚ç‰ˆ)**

**Date:** 2025-11-28 (Updated)
**Based on:** V5/research.md
**Status:** #draft #execution-plan

æ­¤è¨ˆç•«æ—¨åœ¨å¯¦ä½œ V5-ML é«”ç³»ï¼Œå°‡å‚³çµ±çš„å‡å€¼å›æ­¸ç­–ç•¥ï¼ˆL2ï¼‰èˆ‡æ©Ÿå™¨å­¸ç¿’å¸‚å ´é«”åˆ¶è­˜åˆ¥ï¼ˆL1ï¼‰åŠå…ƒæ¨™ç±¤éæ¿¾ï¼ˆL3ï¼‰ç›¸çµåˆã€‚

#### **æ­¥é©Ÿ 0-1ï¼šåŸå§‹æ•¸æ“šä¸‹è¼‰ (Data Download)**

æ­¤æ­¥é©Ÿåƒ…è² è²¬å¾ç¶²è·¯ç²å–æ•¸æ“šä¸¦æš«å­˜ï¼Œä¸é€²è¡Œè¤‡é›œè™•ç†ï¼Œä»¥ç¢ºä¿æ•¸æ“šæºçš„ç´”æ·¨ä¸¦æ¸›å°‘é‡è¤‡ä¸‹è¼‰çš„é¢¨éšªã€‚

* **ç›®æ¨™ï¼š** ä¸‹è¼‰ä¸¦ä¿å­˜ yfinance åŸå§‹æ•¸æ“šã€‚
* **åŸ·è¡Œï¼š**
  1. **è³‡ç”¢æ± æ›´æ–°ï¼š** é–å®šé«˜æµå‹•æ€§æ¨™çš„ (S&P 100 / Nasdaq 100)ã€‚
  2. **ä¸‹è¼‰åŸ·è¡Œï¼š**
     * å‘¼å« yfinance ä¸‹è¼‰å€‹è‚¡ OHLCV (Daily & 60m)ã€‚
     * ä¸‹è¼‰å®è§€å¸‚å ´æŒ‡æ¨™ (SPY, QQQ, IWO, VTI, ^VIX, ^TNX ç­‰)ã€‚
  3. **æš«å­˜ï¼š** å°‡ä¸‹è¼‰å›ä¾†çš„åŸå§‹ DataFrame (Raw Dictionary or Pickle) å­˜å…¥ `data/temp_raw/` ç›®éŒ„ã€‚
* **ç”¢å‡ºæª”æ¡ˆï¼š**
  * `data/temp_raw/raw_tickers_data.pkl` (æˆ–é¡ä¼¼æ ¼å¼)
  * `data/temp_raw/raw_macro_data.pkl`

#### **æ­¥é©Ÿ 0-2ï¼šæ•¸æ“šæ ¼å¼åŒ–èˆ‡å„²å­˜ (Data Formatting to Parquet)**

æ­¤æ­¥é©Ÿè®€å–æš«å­˜çš„åŸå§‹æ•¸æ“šï¼Œé€²è¡Œæ ¼å¼æ¨™æº–åŒ–ï¼ˆStacking, MultiIndexï¼‰ï¼Œç”¢å‡ºä¸‹æ¸¸æ¨¡å‹æ‰€éœ€çš„ Parquet æª”æ¡ˆã€‚

* **ç›®æ¨™ï¼š** è£½ä½œæ¨™æº–åŒ–çš„ `universe_daily.parquet` èˆ‡ `market_indicators.parquet`ã€‚
* **åŸ·è¡Œï¼š**
  1. **è®€å–æš«å­˜æª”ï¼š** è¼‰å…¥æ­¥é©Ÿ 0-1 çš„æ•¸æ“šã€‚
  2. **æ ¼å¼åŒ–ï¼š**
     * è™•ç† MultiIndex (timestamp, symbol)ã€‚
     * è™•ç†æ¬„ä½åç¨±èˆ‡å‹åˆ¥ã€‚
  3. **å„²å­˜ï¼š** å¯«å…¥æ­£å¼çš„ Parquet æª”æ¡ˆã€‚
* **ç”¢å‡ºæª”æ¡ˆï¼š**
  * `data/universe_daily.parquet`: æˆåˆ†è‚¡é¢æ¿æ•¸æ“šã€‚
  * `data/market_indicators.parquet`: VIX, SPY, å‚µåˆ¸æ”¶ç›Šç‡ç­‰å®è§€æ•¸æ“šã€‚

#### **æ­¥é©Ÿ 1ï¼šç‰¹å¾µå·¥ç¨‹ - L0 æ•¸æ“šå±¤ (L0 Feature Engineering)**

æ­¤æ­¥é©Ÿå°‡åŸå§‹åƒ¹æ ¼è½‰æ›ç‚ºæ¨¡å‹å¯ç”¨çš„ç‰¹å¾µï¼Œåˆ†ç‚ºã€Œå¸‚å ´è„†å¼±æ€§ç‰¹å¾µã€èˆ‡ã€Œå€‹è‚¡è¨Šè™Ÿç‰¹å¾µã€ã€‚

* **ç›®æ¨™ï¼š** æ§‹å»ºä¾› L1 (HMM/IsoForest) èˆ‡ L2 (Base Strategy) ä½¿ç”¨çš„ç‰¹å¾µé›†ã€‚
* **åŸ·è¡Œï¼š**
  1. **è®€å–æ•¸æ“šï¼š** è¼‰å…¥ `universe_daily.parquet` èˆ‡ `market_indicators.parquet`ã€‚
  2. **å¸‚å ´ç‰¹å¾µ (For L1):** * è¨ˆç®— **Proxy ETF ç‰¹å¾µ:**
       * **IWO_Volatility:** IWO çš„æ»¾å‹•å·²å¯¦ç¾æ³¢å‹•ç‡ã€‚
       * **SPY_IWO_Divergence:** SPY èˆ‡ IWO ä¹‹é–“çš„æ»¾å‹•å›å ±å·®ç•°ã€‚
     * è¨ˆç®— **æ³¢å‹•ç‡ç‰¹å¾µ:** VIX çš„è®Šå‹•ç‡ã€SPY çš„ Realized Volatilityã€‚
  3. **å€‹è‚¡ç‰¹å¾µ (For L2 & L3):** * **å‡å€¼å›æ­¸å› å­:** RSI(2), Bollinger Band %B, Distance to SMA200ã€‚
     * **ç›¸å°å¼·å¼±:** ç›¸å°æ–¼ SPY çš„ Beta èˆ‡ Alphaã€‚
* **ç”¢å‡ºæª”æ¡ˆï¼š**
  * `features/market_features_L0.parquet`: ç”¨æ–¼é«”åˆ¶è­˜åˆ¥çš„æ™‚é–“åºåˆ—æ•¸æ“šã€‚
  * `features/stock_features_L0.parquet`: ç”¨æ–¼å€‹è‚¡é¸æ“‡çš„é¢æ¿æ•¸æ“šã€‚

#### **æ­¥é©Ÿ 2ï¼šL1 é«”åˆ¶è­˜åˆ¥æ¨¡å‹è¨“ç·´ (Regime Identification Layer)**

å¯¦ä½œã€Œé»‘å¤©éµé˜²ç¦¦ç³»çµ±ã€ï¼Œè¨“ç·´éç›£ç£å¼å­¸ç¿’æ¨¡å‹ä¾†è­˜åˆ¥å¸‚å ´ç‹€æ…‹ã€‚

* **ç›®æ¨™ï¼š** ç”¢å‡ºå¸‚å ´ç‹€æ…‹è¨Šè™Ÿ (State) èˆ‡ç•°å¸¸åˆ†æ•¸ (Anomaly Score)ã€‚
* **åŸ·è¡Œï¼š**
  1. **HMM æ¨¡å‹è¨“ç·´:**
     * ä½¿ç”¨ market_features_L0 (å« Proxy ETF ç‰¹å¾µ) è¨“ç·´ Gaussian HMMã€‚
     * è¨­å®š 3 ç¨®éš±è—ç‹€æ…‹ï¼šç‰›å¸‚ (Bull)ã€éœ‡ç›ª (Chop)ã€å´©ç›¤ (Crash)ã€‚
     * æ ¡æº–ï¼šç¢ºèª "Crash" ç‹€æ…‹èƒ½å°æ‡‰åˆ°æ­·å²ç©ºé ­å¹´ä»½ (2020, 2022)ã€‚
  2. **Isolation Forest è¨“ç·´:**
     * è¨“ç·´ç•°å¸¸æª¢æ¸¬æ¨¡å‹ï¼Œè¼¸å‡ºç•°å¸¸åˆ†æ•¸ã€‚
     * è¨­å®šé–¾å€¼ï¼Œå®šç¾©ä½•ç‚ºã€ŒæœªçŸ¥é¢¨éšªã€ã€‚
* **ç”¢å‡ºæª”æ¡ˆï¼š**
  * `models/hmm_model.joblib`: è¨“ç·´å¥½çš„ HMM æ¨¡å‹ã€‚
  * `models/iso_forest.joblib`: è¨“ç·´å¥½çš„ Isolation Forest æ¨¡å‹ã€‚
  * `signals/regime_signals.parquet`: æ¯æ—¥å¸‚å ´ç‹€æ…‹èˆ‡ç•°å¸¸åˆ†æ•¸çš„æ™‚é–“åºåˆ—ã€‚

#### **æ­¥é©Ÿ 3ï¼šL2 ç­–ç•¥ç”Ÿæˆèˆ‡ L3 å…ƒæ¨™ç±¤æ§‹å»º (Strategy & Meta-Labeling)**

é€™æ˜¯æ ¸å¿ƒé‚è¼¯çš„æ•´åˆæ­¥é©Ÿã€‚å…ˆç”ŸæˆåŸºç¤è¨Šè™Ÿï¼Œå†æ¨™è¨˜é€™äº›è¨Šè™Ÿçš„çœŸå¯¦çµæœï¼Œæœ€å¾Œè¨“ç·´éæ¿¾æ¨¡å‹ã€‚

* **ç›®æ¨™ï¼š** å»ºç«‹ V5 åŸºç¤ç­–ç•¥ä¸¦è¨“ç·´ L3 éæ¿¾å™¨ã€‚
* **åŸ·è¡Œï¼š**
  1. **L2 åŸºç¤ç­–ç•¥æ¨¡æ“¬ (Offense):**
     * é‚è¼¯ï¼šç•¶ Price > SMA200 ä¸” RSI(2) < 10 æ™‚ç”¢ç”Ÿè¨Šè™Ÿã€‚
     * æ’åºï¼šæ¯æ—¥é¸å– RSI æœ€ä½çš„ Top K æª”è‚¡ç¥¨ã€‚
     * å‡ºå ´ï¼šæŒæœ‰ 5 å¤©æˆ– RSI > 70 (å¯é¸)ã€‚
     * **ç”Ÿæˆåˆæ­¥è¨Šè™Ÿåˆ—è¡¨**ã€‚
  2. **æ¨™ç±¤ç”Ÿæˆ (Labeling):**
     * è¨ˆç®—æ¯å€‹ L2 è¨Šè™Ÿåœ¨æœªä¾† 5 å¤©çš„æç›Šã€‚
     * å®šç¾© **Meta-Label (Y)**: è‹¥ç²åˆ© > 0 (æˆ– Sharpe > X)ï¼Œå‰‡ Y=1ï¼Œå¦å‰‡ Y=0ã€‚
  3. **L3 æ¨¡å‹è¨“ç·´ (Optimization):**
     * è¼¸å…¥ï¼šstock_features_L0 + regime_signals (å°‡å¸‚å ´ç‹€æ…‹ä½œç‚ºä¸Šä¸‹æ–‡ç‰¹å¾µ)ã€‚
     * æ¨¡å‹ï¼šXGBoost æˆ– Random Forest Classifierã€‚
     * ç›®æ¨™ï¼šé æ¸¬ P(Profit > 0 | Signal, Context)ã€‚
* **ç”¢å‡ºæª”æ¡ˆï¼š**
  * `signals/base_strategy_trades.parquet`: æœªç¶“éæ¿¾çš„åŸå§‹äº¤æ˜“ç´€éŒ„ã€‚
  * `models/l3_meta_filter.joblib`: L3 éæ¿¾æ¨¡å‹ã€‚
  * `signals/l3_probabilities.csv`: æ¯å€‹åŸå§‹è¨Šè™Ÿçš„ç²åˆ©æ©Ÿç‡é æ¸¬ã€‚

#### **æ­¥é©Ÿ 4ï¼šå›æ¸¬èˆ‡é©—è­‰å”è­° (Backtest & Verification)**

åŸ·è¡Œ research.md ç¬¬ 5 ç¯€å®šç¾©çš„åš´æ ¼é©—è­‰æ¸¬è©¦ã€‚

* **ç›®æ¨™ï¼š** æ¯”è¼ƒ V5-Base, V5+L1, V5+L3 çš„ç¸¾æ•ˆå·®ç•°ã€‚
* **åŸ·è¡Œï¼š**
  1. **åŸºæº–æ¸¬è©¦ (Baseline):** è¨ˆç®— V5 åŸºç¤ç­–ç•¥çš„ Sharpe, Drawdownã€‚
  2. **æ¸¬è©¦ A (é˜²ç¦¦æ»¯å¾Œæ€§):** æ¯”è¼ƒ HMM è­˜åˆ¥å‡º "Crash" ç‹€æ…‹çš„æ™‚é–“é»èˆ‡å¸‚å ´é«˜é»çš„å·®è· (Target < 5 days)ã€‚
  3. **æ¸¬è©¦ B (æ¯’æ€§éæ¿¾):** è©•ä¼° L3 æ¨¡å‹æ˜¯å¦æˆåŠŸéæ¿¾æ‰è™§æ > 5% çš„äº¤æ˜“ (Toxic Signals)ï¼ŒåŒæ™‚ä¿æŒè¶³å¤ çš„å¬å›ç‡ (Recall)ã€‚
  4. **ç¶œåˆå›æ¸¬:** æ¨¡æ“¬æœ€çµ‚è³‡é‡‘æ›²ç·š (Equity Curve)ã€‚
     * ç­–ç•¥é‚è¼¯ï¼šL2 ç”Ÿæˆè¨Šè™Ÿ -> L1 æª¢æŸ¥å¸‚å ´ç‹€æ…‹ (è‹¥ Crash å‰‡ç†”æ–·) -> L3 æª¢æŸ¥ç²åˆ©æ©Ÿç‡ (è‹¥ Prob < Threshold å‰‡éæ¿¾) -> åŸ·è¡Œäº¤æ˜“ã€‚
* **ç”¢å‡ºæª”æ¡ˆï¼š**
  * `analysis/backtest_report.txt`: åŒ…å« Sharpe, DD, Win Rate çš„è©³ç´°å ±å‘Šã€‚
  * `analysis/equity_curves_comparison.png`: ç­–ç•¥ç¸¾æ•ˆæ¯”è¼ƒåœ–ã€‚
  * `analysis/regime_overlay.png`: å¸‚å ´èµ°å‹¢ç–ŠåŠ  HMM ç‹€æ…‹åœ–ã€‚

#### **æ­¥é©Ÿ 5ï¼šåˆæˆå£“åŠ›æ¸¬è©¦ (Optional/Advanced)**

* **ç›®æ¨™ï¼š** ä½¿ç”¨ TimeGAN ç”Ÿæˆæœªè¦‹éçš„å¸‚å ´è·¯å¾‘ï¼Œæ¸¬è©¦ L1 é˜²ç¦¦å±¤çš„ç©©å¥æ€§ã€‚
* **åŸ·è¡Œï¼š**
  * (æ­¤æ­¥é©Ÿç‚ºé€²éšé¸é …ï¼Œè¦–æ™‚é–“èˆ‡è³‡æºæ±ºå®šæ˜¯å¦åœ¨ç¬¬ä¸€éšæ®µå¯¦ä½œ)

### **æª”æ¡ˆèªªæ˜ (Files Summary)**

æœ¬è¨ˆç•«å°‡ç”Ÿæˆä»¥ä¸‹ä¸»è¦çš„ Python è…³æœ¬ï¼š

1. `00_download_data_v5.py`: æ¶µè“‹æ­¥é©Ÿ 0-1ï¼Œè² è²¬å¾ yfinance ä¸‹è¼‰åŸå§‹æ•¸æ“šä¸¦æš«å­˜ã€‚
2. `01_format_data_v5.py`: æ¶µè“‹æ­¥é©Ÿ 0-2ï¼Œè² è²¬å°‡æš«å­˜æ•¸æ“šæ ¼å¼åŒ–ç‚º Parquetã€‚
3. `02_build_features_l0_v5.py`: æ¶µè“‹æ­¥é©Ÿ 1ï¼Œè² è²¬è¨ˆç®— L0 ç‰¹å¾µã€‚
4. `03_train_regime_model_l1.py`: æ¶µè“‹æ­¥é©Ÿ 2ï¼Œè¨“ç·´ HMM èˆ‡ Isolation Forestã€‚
5. `04_train_meta_labeling_l3.py`: æ¶µè“‹æ­¥é©Ÿ 3ï¼Œç”ŸæˆåŸºç¤è¨Šè™Ÿä¸¦è¨“ç·´å…ƒæ¨™ç±¤æ¨¡å‹ã€‚
6. `05_backtest_and_verify.py`: æ¶µè“‹æ­¥é©Ÿ 4ï¼ŒåŸ·è¡Œé©—è­‰å”è­°èˆ‡ç”¢å‡ºå ±å‘Šã€‚